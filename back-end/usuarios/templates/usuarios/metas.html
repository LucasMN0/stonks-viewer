{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StonksViewer</title>

    <link rel="icon" href="{% static 'usuarios/cofrinho.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'usuarios/metas.css' %}">
</head>
<body>
    <div class="navegador-principal">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Stonks Viewer</div>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li><a href="{% url 'perfil' %}">Voltar</a></li>
                    <li><a href="{% url 'sair' %}">Sair</a></li>
                </ul>
            </nav>

            <div class="sidebar-user-profile">
                <div class="user-avatar"></div>
                <div class="user-info">
                    <p class="user-name">{{ request.user.first_name }}</p>
                    <p class="user-email">{{ request.user.email }}</p>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h1>Metas financeiras</h1>
            </header>

            <section class="metas-section">
                <h2>Definir nova meta financeira</h2>

                <form class="metas-form" id="form-metas">
                    <label for="meta-nome">Nome da meta</label>
                    <input type="text" id="meta-nome" required>

                    <label for="meta-valor">Valor alvo</label>
                    <input type="number" id="meta-valor" required>

                    <label for="meta-data">Data inicial</label>
                    <input type="date" id="meta-data" required>

                    <label for="meta-final">Data final</label>
                    <input type="date" id="meta-final" required>

                    <button type="submit">Adicionar Meta</button>
                </form>

                <br><hr><br>
            </section>

            <section class="lista-metas">
                <h2>Metas atuais</h2>
                <div id="container-metas"></div>
            </section>
        </main>
    </div>

<script>
    const container = document.getElementById("container-metas");
    const form = document.getElementById("form-metas");

    // ===============================================================
    // CARREGAR METAS
    // ===============================================================
    async function carregarMetas() {
        const resp = await fetch("/metas/listar/");
        const data = await resp.json();

        exibirMetas(data.metas);
    }

    // ===============================================================
    // EXIBIR METAS NA TELA
    // ===============================================================
    function exibirMetas(metas) {
        container.innerHTML = "";

        metas.forEach(meta => {
            const pct = Math.min((meta.valor_atual / meta.valor) * 100, 100).toFixed(1);

            const div = document.createElement("div");
            div.classList.add("meta-card");

            div.innerHTML = `
                <h3>${meta.nome}</h3>

                <p><strong>Valor alvo:</strong> R$ ${meta.valor}</p>
                <p><strong>Data inicial:</strong> ${meta.data_inicial}</p>
                <p><strong>Data final:</strong> ${meta.data_final}</p>
                <p><strong>Progresso:</strong> R$ ${meta.valor_atual}</p>

                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width:${pct}%"></div>
                </div>
                <small>${pct}% conclu√≠do</small>

                <br>

                <button onclick="adicionarValor(${meta.id})" class="btn-editar">Adicionar valor</button>
                <button onclick="excluirMeta(${meta.id})" class="btn-excluir">Excluir</button>
            `;

            container.appendChild(div);
        });
    }

    // ===============================================================
    // ADICIONAR NOVA META
    // ===============================================================
    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const body = {
            nome: document.getElementById("meta-nome").value,
            valor: document.getElementById("meta-valor").value,
            data_inicial: document.getElementById("meta-data").value,
            data_final: document.getElementById("meta-final").value
        };

        await fetch("/metas/adicionar/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        form.reset();
        carregarMetas();
    });

    // ===============================================================
    // EXCLUIR META
    // ===============================================================
    async function excluirMeta(id) {
        await fetch(`/metas/excluir/${id}/`, {
            method: "DELETE"
        });

        carregarMetas();
    }

    // ===============================================================
    // ADICIONAR PROGRESSO
    // ===============================================================
    async function adicionarValor(id) {
        const valor = Number(prompt("Valor a adicionar:"));

        if (isNaN(valor) || valor <= 0) return;

        await fetch(`/metas/progresso/${id}/`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({valor})
        });

        carregarMetas();
    }

    // ===============================================================
    // INICIAR
    // ===============================================================
    carregarMetas();
</script>

</body>
</html>
